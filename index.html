<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>BAPS2</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>BAPS2</h1>
        <p>Updated version of BAPS. For internal testing only.</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/jlduran/BAPS2" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/jlduran/BAPS2/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/jlduran/BAPS2/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>Blackfin Asterisk Package System (BAPs)</h1>

<h2>Introduction</h2>

<p>Package-based Build System for Blackfin Asterisk. Key differences compared to buildroot based systems like Astfin and uCasterisk:</p>

<ul>
<li>
<p>End users do not need to compile any software, they just install them on a running Blackfin system, for example:</p>

<pre><code>root:~&gt; ipkg install asterisk
</code></pre>

<p>will grab the latest Asterisk package from a web site and install it on a Blackfin based hardware platform. Use is not limited to Asterisk, it could be used to manage any Blackfin software, including the kernel. The use of ipkg is very common on the OpenWRT project, and similar package based systems are common on x86 Linux, e.g. apt-get, debs, rpms.</p>

<p>Note that software is installed at run time rather than build time. Packages (via ipkg) are used to install applications like Asterisk, rather than placing everything in a uImage. The target hardware is initially booted with a basic kernel and root file system, then packages are installed as required. We assume availability of persistent (non ram) based file system like yaffs or jffs2.</p>

<p>The goal is to make installing software on the Blackfin much easier for end-users, more like an x86 experience.</p>
</li>
<li><p>Compared to buildroot systems BAPS has a flat directory structure to ease development (less wear on your tab key). It is designed to allow modular compilation of packages, e.g. you can compile a single application without building the entire uImage. Faster and less output to wade through. Makefiles (e.g. asterisk.mk) and source (e.g. asterisk-1.4.4) are within one directory level of each other for easy navigation of the source tree. There is less chance of breaking the build system due to decoupling of modules (kernel, root fs, are separate from Asterisk).</p></li>
</ul><h2>Packages</h2>

<p>In addition to an IP08/IP04/IP01 uImage (kernel plus basic root filesystem) there is a growing list of packages:</p>

<table>
<tr>
<th>Name</th>
<th>Description</th>
  </tr>
<tr>
<td>asterisk</td>
<td>Asterisk is a complete PBX in software. It provides all of the features you would expect from a PBX and more. Asterisk does voice over IP in three protocols, and can interoperate with almost all standards-based telephone equipment using relatively inexpensive hardware.</td>
  </tr>
<tr>
<td>dropbear</td>
<td>Dropbear is a relatively small SSH 2 server and client.</td>
  </tr>
<tr>
<td>g729</td>
<td>G.729 Codec.</td>
  </tr>
<tr>
<td>libgmp</td>
<td>GNU MP is a portable library written in C for arbitrary precision arithmetic on integers, rational numbers, and floating-point numbers. It aims to provide the fastest possible arithmetic for all applications that need higher precision than is directly supported by the basic C types.</td>
  </tr>
<tr>
<td>libssl</td>
<td>A toolkit implementing SSL v2/v3 and TLS protocols with full-strength cryptography world-wide.</td>
  </tr>
<tr>
<td>libtiff</td>
<td>Tiff image file format library.</td>
  </tr>
<tr>
<td>libxml</td>
<td>A library for manipulating XML and HTML resources.</td>
  </tr>
<tr>
<td>openvpn</td>
<td>A web-scale networking platform enabling the next wave of VPN services.</td>
  </tr>
<tr>
<td>oslec</td>
<td>Open Source Line Echo Canceller, a high quality free echo canceller for Asterisk.</td>
  </tr>
<tr>
<td>spandsp</td>
<td>Telephony Algorithms and Digital Signal Processing Routines.</td>
  </tr>
<tr>
<td>vim</td>
<td>Vim is an almost compatible version of the UNIX editor Vi.</td>
  </tr>
<tr>
<td>zaptel</td>
<td>Telephony hardware drivers for IP04 SPI-over-SPORT1 version (later Atcom IP04s, IP08s).</td>
  </tr>
</table><h2>Getting Started</h2>

<p>The installation of the BAPs uImage is still a little complex (apologies). It requires working with u-boot using the RS-232 console interface. For more information on this process please see the <a href="http://www.voip-info.org/wiki/view/IP04+Open+Hardware+IP-PBX">IP04 Wiki</a> or please post to the Blackfin Asterisk forum.</p>

<p>However once the uImage is installed life gets much easier!</p>

<p>This process will <strong>erase your IP04 root file system</strong> so please backup anything you really need (like your asterisk conf files).</p>

<ol>
<li>
<p>Get the baseline BAPs uImage (contains kernel and basic root file system) and place it on your tftp server:</p>

<pre><code>http://www.rowetel.com/ucasterisk/downloads/uImage_r4.ip08
</code></pre>

<blockquote>
<p><strong>NOTE:</strong> Despite it's name, uImage_r4.ip08 works fine on both the IP04 and IP08.</p>
</blockquote>
</li>
<li>
<p>Connect an RS-232 cable to your IP04 (via the daughter board) and stop the boot process at the u-boot prompt.
Now we are going to write the new uImage to flash. You only need to configure ethaddr1 if you have two ethernet interfaces.</p>

<blockquote>
<p><strong>CAUTION:</strong> Do not cut/paste the steps below into your serial terminal program, as they often cannot respond fast enough and lose characters. Type each line carefully by hand.</p>
</blockquote>

<p>Install the new uImage into NAND flash using u-boot:</p>

<pre><code>ip04&gt;set autostart
ip04&gt;set serverip your.tftp.server
ip04&gt;tftp 0x1000000 uImage_r2.ip08
ip04&gt;nand erase clean
ip04&gt;nand erase
ip04&gt;nand write 0x1000000 0x0 0x300000
ip04&gt;set bootargs ethaddr=$(ethaddr) ethaddr1=$(ethaddr1) $(con) root=/dev/mtdblock0 rw
ip04&gt;save
ip04&gt;bootm 0x1000000
</code></pre>

<p>(uClinux will boot...)</p>

<blockquote>
<p><strong>TIP:</strong> If Linux doesn't boot or you experience other problems reboot into uboot, type <code>print</code>, and carefully check bootargs.</p>
</blockquote>
</li>
<li>
<p>Now we have uClinux running, but using a ram-based ext2 file system (mtdblock0) for root. So we need to copy /root into the yaffs file system:</p>

<p>On the IP04:</p>

<pre><code>root:~&gt; copy_rootfs.sh
root:~&gt; reboot
</code></pre>
</li>
<li>
<p>Now set up u-boot to mount root from yaffs (some of these env variables may be set already, use <code>print</code> to check):</p>

<pre><code>ip04&gt;set autostart yes
ip04&gt;set bootargs ethaddr=$(ethaddr) ethaddr1=$(ethaddr1) $(con) $(root)
ip04&gt;set nandboot 'nboot 0x2000000 0x0'
ip04&gt;set bootcmd run nandboot
ip04&gt;save
ip04&gt;reset
</code></pre>
</li>
<li>
<p>Boot IP04 to a uClinux root prompt.  Use mount to check that root is mounted on mtdblock2 (yaffs file system).</p>

<p>Now we can install some packages using ipkg:</p>

<pre><code>$root:~&gt; ipkg update
$root:~&gt; ipkg install zaptel-spi asterisk native-sounds
$root:~&gt; reboot
</code></pre>
</li>
</ol><h2>Documentation</h2>

<p>After installation many packages include documentation in the /usr/doc directory of the IP04.  These are small files designed to capture Blackfin or IP04 specific information, for example simple tests and notes on differences from other versions of the same package. The documentation files can also be browsed from <a href="http://svn.astfin.org/software/baps/trunk/doc">BAPS2 git</a>.</p>

<h2>HOWTO - Developer</h2>

<ol>
<li>
<p>Clone BAPS2:</p>

<pre><code>$ git clone git://github.com/jlduran/BAPS2.git
$ cd BAPS2
</code></pre>
</li>
<li>
<p>You need to install the toolchain and uClibc:</p>

<pre><code>[BAPS2]$ wget http://download.analog.com/27516/frsrelease/5/0/8/5087/blackfin-toolchain-08r1.5-14.i386.tar.bz2
[BAPS2]$ tar xjf blackfin-toolchain-08r1.5-14.i386.tar.bz2
[BAPS2]$ wget http://download.analog.com/27516/frsrelease/5/0/7/5075/blackfin-toolchain-uclibc-default-08r1.5-14.i386.tar.bz2
[BAPS2]$ tar xjf blackfin-toolchain-uclibc-default-08r1.5-14.i386.tar.bz2
</code></pre>

<p>If you untar the toolchain and uClibc in the BAPS2 directory, it will be included in your path automatically. If you untar it somewhere else make sure the bin directories in this toolchain are in your path.</p>
</li>
<li>
<p>Make a BAPS2 uImage that supports ipkg. This also configures uClinux-dist to support compiling of other packages. You need to make uClinux before making any other packages.</p>

<pre><code>[BAPS2]$ make -f uClinux.mk uClinux
[BAPS2]$ cp uClinux-dist/images/uImage /tftpboot/uImage
</code></pre>

<p>You can then try booting from your uImage via tftp, in u-boot:</p>

<pre><code>ip04&gt;set autostart
ip04&gt;set bootargs ethaddr=your:mac:address root=/dev/mtdblock0 rw
ip04&gt;save
ip04&gt;tftp 0x1000000 uImage
ip04&gt;bootm
</code></pre>

<p>Or you can flash the uImage as described in the <a href="#getting-started">Getting Started</a> section above.</p>
</li>
<li>
<p>Check out ipkg.conf:</p>

<pre><code>root:~&gt; cat /etc/ipkg.conf
src snapshots http://rowetel.com/ucasterisk/ipkg
dest root /
</code></pre>

<p>Try installing a simple ipkgs:</p>

<pre><code>root:~&gt; ipkg update
root:~&gt; ipkg list
root:~&gt; ipkg install hello
root:~&gt; hello
</code></pre>
</li>
<li>
<p>BAPS uses init.d type start up scripts, for example:</p>

<pre><code>root:~&gt; ls /etc/init.d
root:~&gt; /etc/init.d/hello
root:~&gt; /etc/init.d/hello enable
root:~&gt; ls -l /etc/rc.d/
</code></pre>
</li>
</ol><h2>HOWTO - IPKG</h2>

<p>To build the ipkg:</p>

<pre><code>[BAPS2]$ make -f hello.mk hello
[BAPS2]$ make -f hello.mk hello-package
[BAPS2]$ ls ipkg
</code></pre>

<p>To create an index file:</p>

<pre><code>[BAPS2]$ cd ipkg
[BAPS2]$ ../scripts/ipkg-make-index.sh . &gt; Packages
[BAPS2]$ scp Packages /your/web/server
</code></pre>

<p>Then change the first line in /etc/ipkg.conf on your IP04:</p>

<pre><code>src snapshots http://you.web.server
</code></pre>

<p>And try:</p>

<pre><code>root:~&gt; ipkg update
root:~&gt; ipkg list
</code></pre>

<h3>Notes</h3>

<ol>
<li><p>If you change the post or pre inst scripts, it is a good idea to rm the existing $(TARGET_DIR) (see Makefile for your package), as the package make scripts don't seem to recognise when post/pre scripts have been changed.</p></li>
<li><p>To debug post/pre inst scripts <code>#!/bin/sh -x</code> is your friend!</p></li>
<li>
<p>To test ipkgs you can rcp down to the target:</p>

<pre><code>[host]$ rcp ipkg/asterisk_1.4.4-1_bfin.ipk root@ip04:/root
[ip04]$ ipkg install asterisk_1.4.4-1_bfin.ipk
</code></pre>

<p>If you get complaints about MD5 mismatch, then:</p>

<pre><code>[ip04]$ rm /usr/lib/ipkg/lists/snapshots
</code></pre>
</li>
</ol><h2>HOWTO - uClinux Changes</h2>

<p>Say you have changed a busybox option, or modified some files in uClinux-dist.  To capture the changes to patches in git:</p>

<pre><code>[BAPS2]$ make -f uClinux.mk uClinux-ip04-make-patch
[BAPS2]$ git status
</code></pre>

<p>Tips:</p>

<p>To change linux kernel options:</p>

<pre><code>[BAPS2]$ cd uClinux-dist
[uClinux-dist]$ make linux_menuconfig
</code></pre>

<p>To change user application and library settings:</p>

<pre><code>[BAPS2]$ cd uClinux-dist
[uClinux-dist]$ make config_menuconfig
</code></pre>

<p>To modify the IP04 rc, motd etc:</p>

<pre><code>[BAPS2]$ cd uClinux-dist/vendors/Rowetel/IP04
</code></pre>

<p>Then capture changes as above with:</p>

<pre><code>[BAPS2]$ make -f uClinux.mk uClinux-ip04-make-patch
</code></pre>

<h3>Notes</h3>

<ol>
<li><p>Patch files are compatible with Astfin, so hopefully it's possible to move patches back and forth between BAPS2 and Astfin.</p></li>
<li><p>See TODO.txt</p></li>
<li>
<p>To debug init shell scripts, e.g. files/hello.init, add a -x to the first line if the script using vi on the IP04:</p>

<pre><code>#!/bin/sh -x
</code></pre>
</li>
<li>
<p>When writing init scripts your will find the busybox msh shell has some quirks, here is a link that explains them:</p>

<pre><code>http://dslinux.org/cgi-bin/moin.cgi/DSLinuxMshScriptingGuide?action=show&amp;redirect=DSLinux+msh+scripting+guide
</code></pre>
</li>
<li>
<p>For more information on the IPKG format:</p>

<pre><code>http://handhelds.org/moin/moin.cgi/Ipkg
</code></pre>
</li>
<li><p>On the target, the ipkg data is stored in /usr/lib/ipkg/info/</p></li>
</ol><h2>Directories</h2>

<p>ipkg - completed packages are placed here</p>

<p>include - from OpenWRT kamikaze, contains useful stuff for building packages</p>

<p>scripts - useful scripts from OpenWRT kamikaze</p>

<p>patch - patches for all packages</p>

<p>files - start up scripts for packages, get copied to /etc/init.d on target</p>

<h2>Credits</h2>

<p>Thanks to: Jeff Knighton, Alex Tao, Ming C (Vincent) Li, Mike Taht, Keith Huang, Mark Hindess, Nick Basil, Michael O'Conner, Darryl Ross, Jose Luis Duran and Kelvin Chua for contributing.</p>

<h2>BAPS2 TODO</h2>

<p>Some tasks that need doing...:</p>

<ol>
<li>Work out a way to install uImage.ip08 without u-boot, i.e. from a uClinux root prompt.  This will take much of the pain away, kernels can then be treated like packages.</li>
<li>Can we install kernels (uImage) using a package and no u-boot/RS-232?</li>
<li>Should we separate kernel from baseline root file system install?</li>
<li>BAPS uImages for BF537</li>
<li>A way to build all packages needed for development, like ip08.mk, or maybe set up dependencies in existing Makefile, e.g. so that libssl.mk is called when making asterisk. Not sure about the best way to go here - the idea behind BAPs is to modularise compilation so I am sensitive to having many dependencies and all the extra output that would generate on the command line.</li>
<li>Fix the Maintainer Field in packages (e.g. specific entries for each package).</li>
</ol>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/jlduran">jlduran</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>